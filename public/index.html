<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Samurai Slot</title>
    <script src="https://pixijs.download/v7.x/pixi.min.js"></script>
    <style>
        body { 
            margin: 0; 
            background-color: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; /* Evita barras de rolagem */
            font-family: 'Courier New', monospace; 
        }
        
        /* Camada da Interface (Bot√µes e Textos) */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            text-align: center;
            width: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #spinBtn {
            pointer-events: auto;
            background: linear-gradient(45deg, #00ffcc, #0099ff);
            border: 2px solid #fff;
            padding: 20px 60px;
            font-size: 28px;
            font-weight: 900;
            color: #050510;
            cursor: pointer;
            box-shadow: 0 0 20px #00ffcc;
            border-radius: 50px;
            text-transform: uppercase;
            transition: transform 0.1s;
        }

        #spinBtn:active { transform: scale(0.95); }
        #spinBtn:disabled { background: #333; box-shadow: none; color: #777; border-color: #555; cursor: not-allowed; }

        #msg { 
            color: #fff; 
            font-size: 24px; 
            margin-bottom: 20px; 
            text-shadow: 0 0 10px #00ffcc; 
            background-color: rgba(0,0,0,0.7);
            display: inline-block;
            padding: 10px 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="msg">PRESSIONE GIRAR</div>
        <br>
        <button id="spinBtn">GIRAR üó°Ô∏è</button>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO DO PIXIJS ---
        const app = new PIXI.Application({
            width: 800,
            height: 600,
            backgroundColor: 0x000000,
            resolution: window.devicePixelRatio || 1,
        });
        document.body.appendChild(app.view);

        // --- SISTEMA DE REDIMENSIONAMENTO (RESPONSIVO) ---
        function resize() {
            const ratio = Math.min(window.innerWidth / 800, window.innerHeight / 600);
            app.stage.scale.set(ratio);
            app.renderer.resize(800 * ratio, 600 * ratio);
            
            // Centraliza o container principal na tela
            if(reelContainer) {
                reelContainer.x = (app.screen.width - (REEL_WIDTH * 3 * ratio)) / 2;
                // Centraliza verticalmente se sobrar espa√ßo
                const availableHeight = app.screen.height;
                const machineHeight = 600 * ratio; 
                // Ajuste fino para n√£o ficar colado no topo
                reelContainer.y = 50 * ratio; 
            }
        }
        window.addEventListener('resize', resize);

        // Vari√°veis Globais
        const REEL_WIDTH = 200;
        const SYMBOL_SIZE = 150; // Tamanho ideal do √≠cone
        const reels = [];
        const reelContainer = new PIXI.Container();
        
        let slotTextures = [];

        // --- 1. CARREGAMENTO DOS ASSETS ---
        async function init() {
            try {
                // Carrega assets (TexturePacker + Fundo)
                // Se der erro aqui, verifique se os nomes dos arquivos est√£o certos na pasta assets
                const texturePromise = PIXI.Assets.load('assets/samurai.json');
                const bgPromise = PIXI.Assets.load('assets/background.png');
                
                const [sheet, bgTexture] = await Promise.all([texturePromise, bgPromise]);

                // Configura o Fundo (Background)
                const background = new PIXI.Sprite(bgTexture);
                background.width = 800;
                background.height = 600;
                background.alpha = 0.5; // Escurece o fundo
                app.stage.addChild(background);

                // Adiciona a m√°quina na frente do fundo
                app.stage.addChild(reelContainer);

                // Carrega as texturas dos √≠cones
                // IMPORTANTE: Os nomes aqui devem bater com os nomes dentro do TexturePacker
                slotTextures = [
                    sheet.textures['samurai.png'], 
                    sheet.textures['robo.png'],
                    sheet.textures['espada.png'],
                    sheet.textures['moeda.png'],
                    sheet.textures['neon.png']
                ];

                createMachine();
                resize(); // Ajusta o tamanho da tela na primeira vez
            } catch (error) {
                console.error("ERRO CR√çTICO:", error);
                document.getElementById('msg').innerText = "ERRO: Verifique o console (F12)";
                document.getElementById('msg').style.color = "red";
            }
        }

        // --- 2. CRIA√á√ÉO DA M√ÅQUINA (COM CORRE√á√ÉO DE TAMANHO) ---
        function createMachine() {
            reelContainer.y = 50;
            reelContainer.x = (800 - (REEL_WIDTH * 3)) / 2; 

            for (let i = 0; i < 3; i++) {
                const reelColumn = new PIXI.Container();
                reelColumn.x = i * REEL_WIDTH;
                reelContainer.addChild(reelColumn);

                const reel = {
                    container: reelColumn,
                    symbols: [],
                    blur: new PIXI.BlurFilter(),
                };
                
                reel.blur.blurX = 0;
                reel.blur.blurY = 0;
                reelColumn.filters = [reel.blur];

                // Cria 4 s√≠mbolos iniciais para preencher a coluna
                for (let j = 0; j < 4; j++) {
                    const texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];
                    const symbol = new PIXI.Sprite(texture);
                    
                    symbol.y = j * SYMBOL_SIZE;
                    symbol.anchor.set(0.5); // Ponto central da imagem
                    symbol.x = REEL_WIDTH / 2; // Centraliza na coluna

                    // --- A M√ÅGICA: FOR√áA A IMAGEM A FICAR PEQUENA ---
                    // Isso conserta o bug da "espada gigante"
                    const scaleX = (SYMBOL_SIZE * 0.8) / symbol.width;
                    const scaleY = (SYMBOL_SIZE * 0.8) / symbol.height;
                    const finalScale = Math.min(scaleX, scaleY); // Usa o menor para n√£o distorcer
                    symbol.scale.set(finalScale);
                    // ------------------------------------------------

                    reelColumn.addChild(symbol);
                    reel.symbols.push(symbol);
                }
                reels.push(reel);
            }

            document.getElementById('spinBtn').addEventListener('click', startSpin);
        }

        // --- 3. L√ìGICA DE GIRO ---
        async function startSpin() {
            const btn = document.getElementById('spinBtn');
            const msg = document.getElementById('msg');
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            msg.innerText = "CYBER SPIN...";
            msg.style.color = "#00ffcc";

            // Ativa o desfoque (Blur) para dar sensa√ß√£o de velocidade
            reels.forEach(r => { r.blur.blurY = 20; });

            try {
                // Chama o Backend
                const response = await fetch('/spin', { method: 'POST' });
                const data = await response.json();

                // Fun√ß√£o para parar cada rolo
                const stopReel = (index) => {
                    setTimeout(() => {
                        const reel = reels[index];
                        reel.blur.blurY = 0; // Remove o borr√£o

                        // Define a imagem final baseada na resposta do servidor
                        const textureName = data.reels[index] + ".png"; 
                        const newTexture = PIXI.Assets.cache.get('assets/samurai.json').textures[textureName];

                        // Atualiza a imagem do meio (a que vale)
                        const targetSymbol = reel.symbols[1];
                        targetSymbol.texture = newTexture;
                        
                        // --- REAPLICA A CORRE√á√ÉO DE TAMANHO NA NOVA IMAGEM ---
                        targetSymbol.scale.set(1); // Reseta escala
                        const scaleX = (SYMBOL_SIZE * 0.8) / targetSymbol.width;
                        const scaleY = (SYMBOL_SIZE * 0.8) / targetSymbol.height;
                        targetSymbol.scale.set(Math.min(scaleX, scaleY));
                        // ----------------------------------------------------

                        // Troca os outros s√≠mbolos aleatoriamente
                        reel.symbols[0].texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];
                        reel.symbols[2].texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];

                        // Efeito visual de "tranco" ao parar
                        const startY = reel.container.y;
                        reel.container.y = startY + 30;
                        setTimeout(() => { reel.container.y = startY; }, 150);

                        // Se for o √∫ltimo rolo
                        if (index === 2) {
                            btn.disabled = false;
                            if (data.win) {
                                msg.innerText = `BIG WIN! ${data.multiplier}x`;
                                msg.style.color = "#ffcc00"; 
                            } else {
                                msg.innerText = "TENTE NOVAMENTE";
                                msg.style.color = "#fff";
                            }
                        }
                    }, index * 400 + 800);
                };

                stopReel(0);
                stopReel(1);
                stopReel(2);

            } catch (e) {
                console.error(e);
                msg.innerText = "ERRO DE REDE";
                msg.style.color = "red";
                btn.disabled = false;
                reels.forEach(r => { r.blur.blurY = 0; });
            }
        }

        init();
    </script>
</body>
</html>
