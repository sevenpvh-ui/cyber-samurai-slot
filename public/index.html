<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Samurai Slot</title>
    <script src="https://pixijs.download/v7.x/pixi.min.js"></script>
    <style>
        body { 
            margin: 0; 
            background-color: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden;
            font-family: 'Courier New', monospace; /* Fonte estilo Hacker */
        }
        
        /* Camada da Interface (Bot√µes e Textos HTML em cima do Canvas) */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            text-align: center;
            width: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #spinBtn {
            pointer-events: auto;
            background: linear-gradient(45deg, #00ffcc, #0099ff);
            border: 2px solid #fff;
            padding: 20px 60px;
            font-size: 28px;
            font-weight: 900;
            color: #050510;
            cursor: pointer;
            box-shadow: 0 0 20px #00ffcc;
            border-radius: 50px;
            text-transform: uppercase;
            transition: transform 0.1s;
        }

        #spinBtn:active { transform: scale(0.95); }
        #spinBtn:disabled { background: #333; box-shadow: none; color: #777; border-color: #555; cursor: not-allowed; }

        #msg { 
            color: #fff; 
            font-size: 24px; 
            margin-bottom: 20px; 
            text-shadow: 0 0 10px #00ffcc; 
            background-color: rgba(0,0,0,0.7);
            display: inline-block;
            padding: 10px 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="msg">PRESSIONE GIRAR</div>
        <br>
        <button id="spinBtn">GIRAR üó°Ô∏è</button>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO DO PIXIJS ---
        const app = new PIXI.Application({
            width: 800,
            height: 600,
            backgroundColor: 0x000000,
        });
        document.body.appendChild(app.view);

        // Ajuste de escala para telas menores (Responsividade simples)
        function resize() {
            const ratio = Math.min(window.innerWidth / 800, window.innerHeight / 600);
            app.stage.scale.set(ratio);
            app.renderer.resize(800 * ratio, 600 * ratio);
            // Centraliza o container principal
            if(reelContainer) {
                reelContainer.x = (app.screen.width - (REEL_WIDTH * 3 * ratio)) / 2;
            }
        }
        window.addEventListener('resize', resize);

        // Vari√°veis Globais
        const REEL_WIDTH = 200;
        const SYMBOL_SIZE = 160; 
        const reels = [];
        const reelContainer = new PIXI.Container();
        
        let slotTextures = [];

        // --- 1. CARREGAMENTO DOS ASSETS ---
        async function init() {
            try {
                // Carrega o JSON do TexturePacker e o Fundo ao mesmo tempo
                const texturePromise = PIXI.Assets.load('assets/samurai.json');
                const bgPromise = PIXI.Assets.load('assets/background.png');
                
                const [sheet, bgTexture] = await Promise.all([texturePromise, bgPromise]);

                // Configura o Fundo
                const background = new PIXI.Sprite(bgTexture);
                background.width = 800;  // Largura fixa interna
                background.height = 600; // Altura fixa interna
                background.alpha = 0.5;  // Escurece para destacar os slots
                app.stage.addChild(background); // Adiciona na camada 0 (fundo)

                // Adiciona o container dos slots na frente do fundo
                app.stage.addChild(reelContainer);

                // Prepara as texturas (baseado nos nomes dos seus arquivos PNG)
                slotTextures = [
                    sheet.textures['samurai.png'], 
                    sheet.textures['robo.png'],
                    sheet.textures['espada.png'],
                    sheet.textures['moeda.png'],
                    sheet.textures['neon.png']
                ];

                createMachine();
                resize(); // Ajusta tamanho inicial
            } catch (error) {
                console.error("ERRO CR√çTICO:", error);
                document.getElementById('msg').innerText = "ERRO: Verifique a pasta assets!";
                document.getElementById('msg').style.color = "red";
            }
        }

        // --- 2. CRIA√á√ÉO DA M√ÅQUINA ---
        function createMachine() {
            // Centraliza visualmente o container de rolos
            reelContainer.y = 50;
            reelContainer.x = (800 - (REEL_WIDTH * 3)) / 2; 

            for (let i = 0; i < 3; i++) {
                const reelColumn = new PIXI.Container();
                reelColumn.x = i * REEL_WIDTH;
                reelContainer.addChild(reelColumn);

                const reel = {
                    container: reelColumn,
                    symbols: [],
                    blur: new PIXI.BlurFilter(),
                };
                
                // Configura o filtro de desfoque (Blur)
                reel.blur.blurX = 0;
                reel.blur.blurY = 0;
                reelColumn.filters = [reel.blur];

                // Cria 4 s√≠mbolos iniciais (para cobrir a tela)
                for (let j = 0; j < 4; j++) {
                    const symbol = new PIXI.Sprite(slotTextures[Math.floor(Math.random() * slotTextures.length)]);
                    symbol.y = j * SYMBOL_SIZE;
                    // Centraliza o s√≠mbolo dentro da coluna
                    symbol.anchor.set(0.5); 
                    symbol.x = REEL_WIDTH / 2;
                    symbol.scale.set(0.6); // Ajusta tamanho da imagem se for muito grande
                    
                    reelColumn.addChild(symbol);
                    reel.symbols.push(symbol);
                }
                reels.push(reel);
            }

            // Ativa o bot√£o
            document.getElementById('spinBtn').addEventListener('click', startSpin);
        }

        // --- 3. L√ìGICA DE GIRO ---
        async function startSpin() {
            const btn = document.getElementById('spinBtn');
            const msg = document.getElementById('msg');
            
            if (btn.disabled) return;
            
            // Estado de Giro
            btn.disabled = true;
            msg.innerText = "GIRANDO...";
            msg.style.color = "#00ffcc";

            // Aplica efeito de velocidade (Blur)
            reels.forEach(r => { r.blur.blurY = 20; });

            try {
                // Chama o Backend
                const response = await fetch('/spin', { method: 'POST' });
                const data = await response.json();

                // Fun√ß√£o para parar cada rolo
                const stopReel = (index) => {
                    setTimeout(() => {
                        const reel = reels[index];
                        reel.blur.blurY = 0; // Tira o borr√£o

                        // Define qual imagem deve aparecer (Resultado do servidor)
                        // Backend manda "samurai", n√≥s adicionamos ".png" para achar no JSON
                        const textureName = data.reels[index] + ".png"; 
                        const texture = PIXI.Assets.cache.get('assets/samurai.json').textures[textureName];

                        // Troca as texturas visualmente
                        // Mudamos o segundo s√≠mbolo (o central) para o resultado
                        reel.symbols[1].texture = texture;
                        // Embaralha os outros s√≥ para variar
                        reel.symbols[0].texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];
                        reel.symbols[2].texture = slotTextures[Math.floor(Math.random() * slotTextures.length)];

                        // Efeito de "Tranco" (Shake) ao parar
                        const startY = reel.container.y;
                        reel.container.y = startY + 30;
                        setTimeout(() => { reel.container.y = startY; }, 150);

                        // Se for o √∫ltimo rolo, finaliza
                        if (index === 2) {
                            btn.disabled = false;
                            if (data.win) {
                                msg.innerText = `üí∞ BIG WIN! ${data.multiplier}x üí∞`;
                                msg.style.color = "#ffcc00"; // Dourado
                                playWinAnimation(); // (Opcional: implementar efeitos de part√≠culas)
                            } else {
                                msg.innerText = "TENTE NOVAMENTE";
                                msg.style.color = "#fff";
                            }
                        }
                    }, index * 400 + 800); // Tempos: 0.8s, 1.2s, 1.6s
                };

                stopReel(0);
                stopReel(1);
                stopReel(2);

            } catch (e) {
                console.error(e);
                msg.innerText = "ERRO DE CONEX√ÉO";
                msg.style.color = "red";
                btn.disabled = false;
                reels.forEach(r => { r.blur.blurY = 0; });
            }
        }

        // Placeholder para anima√ß√£o futura
        function playWinAnimation() {
            // Aqui poder√≠amos adicionar confetes ou raios
            console.log("Efeitos de vit√≥ria!");
        }

        init();
    </script>
</body>
</html>
